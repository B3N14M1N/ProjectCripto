<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Messaging (AES + RSA)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #343a40; color: white; font-weight: bold; }
        .arrow-down { text-align: center; font-size: 2rem; color: #6c757d; margin: 10px 0; }
        textarea { font-family: monospace; font-size: 0.9rem; }
        .debug-info { font-size: 0.85rem; color: #dc3545; }
        .step-badge { background-color: #0d6efd; color: white; padding: 5px 10px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>Secure Messaging System <small class="text-muted">(AES + RSA)</small></h1>
            <button type="button" class="btn btn-outline-info mt-2" data-bs-toggle="modal" data-bs-target="#infoModal">
                ℹ️ How it works?
            </button>
        </div>

        <div class="row">
            <!-- Step 1: Receiver Keys -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header"><span class="step-badge">1</span>Receiver Setup</div>
                    <div class="card-body">
                        <p class="card-text">Generate RSA Key Pair for the Receiver. The <strong>Public Key</strong> will be shared with the Sender.</p>
                        <button id="btn-generate" class="btn btn-primary w-100 mb-3">Generate RSA Keys</button>
                        
                        <div class="mb-3">
                            <label class="form-label">Public Key (Share this)</label>
                            <textarea id="public-key" class="form-control" rows="4" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Private Key (Keep secret)</label>
                            <textarea id="private-key" class="form-control" rows="4" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Sender -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header"><span class="step-badge">2</span>Sender</div>
                    <div class="card-body">
                        <p class="card-text">Encrypt a message using AES, then encrypt the AES key with the Receiver's Public Key.</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <input type="text" id="message-input" class="form-control" placeholder="Hello World">
                        </div>
                        
                        <button id="btn-encrypt" class="btn btn-success w-100 mb-3" disabled>Encrypt & Send</button>

                        <div id="sender-debug" class="d-none">
                            <hr>
                            <h6>Debug Info:</h6>
                            <p><strong>Generated AES Key:</strong> <span id="debug-aes-key" class="text-break debug-info"></span></p>
                            
                            <label class="form-label">Encrypted Message (AES)</label>
                            <textarea id="enc-message" class="form-control mb-2" rows="2" readonly></textarea>
                            
                            <label class="form-label">Encrypted AES Key (RSA)</label>
                            <textarea id="enc-key" class="form-control mb-2" rows="2" readonly></textarea>
                            
                            <label class="form-label">IV</label>
                            <input type="text" id="iv" class="form-control" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Receiver -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header"><span class="step-badge">3</span>Receiver</div>
                    <div class="card-body">
                        <p class="card-text">Receive the package and decrypt it using the Private Key.</p>
                        
                        <div class="alert alert-secondary">
                            <small>Simulating transmission...</small>
                            <div id="transmission-status" class="text-muted">Waiting for data...</div>
                        </div>

                        <button id="btn-decrypt" class="btn btn-warning w-100 mb-3" disabled>Decrypt Message</button>

                        <div id="receiver-result" class="d-none">
                            <hr>
                            <h6>Decryption Result:</h6>
                            <p><strong>Decrypted AES Key:</strong> <span id="res-aes-key" class="text-break debug-info"></span></p>
                            <div class="alert alert-success mt-3">
                                <strong>Message:</strong> <span id="final-message" class="fs-5"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elements
        const btnGenerate = document.getElementById('btn-generate');
        const btnEncrypt = document.getElementById('btn-encrypt');
        const btnDecrypt = document.getElementById('btn-decrypt');
        
        const txtPublicKey = document.getElementById('public-key');
        const txtPrivateKey = document.getElementById('private-key');
        const txtMessage = document.getElementById('message-input');
        
        const senderDebug = document.getElementById('sender-debug');
        const debugAesKey = document.getElementById('debug-aes-key');
        const txtEncMessage = document.getElementById('enc-message');
        const txtEncKey = document.getElementById('enc-key');
        const txtIv = document.getElementById('iv');

        const transmissionStatus = document.getElementById('transmission-status');
        const receiverResult = document.getElementById('receiver-result');
        const resAesKey = document.getElementById('res-aes-key');
        const finalMessage = document.getElementById('final-message');

        // State
        let currentEncryptedData = null;

        // 1. Generate Keys
        btnGenerate.addEventListener('click', async () => {
            btnGenerate.disabled = true;
            btnGenerate.textContent = "Generating...";
            
            try {
                const res = await fetch('/api/generate-keys', { method: 'POST' });
                const data = await res.json();
                
                txtPublicKey.value = data.public_key;
                txtPrivateKey.value = data.private_key;
                
                btnEncrypt.disabled = false;
                btnGenerate.textContent = "Regenerate Keys";
                btnGenerate.disabled = false;
            } catch (e) {
                alert("Error generating keys");
                btnGenerate.disabled = false;
            }
        });

        // 2. Encrypt
        btnEncrypt.addEventListener('click', async () => {
            const msg = txtMessage.value;
            const pubKey = txtPublicKey.value;
            
            if (!msg) return alert("Please enter a message");
            if (!pubKey) return alert("Please generate keys first");

            try {
                const res = await fetch('/api/encrypt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: msg, public_key: pubKey })
                });
                const data = await res.json();

                // Show Debug Info
                senderDebug.classList.remove('d-none');
                debugAesKey.textContent = data.aes_key_debug;
                txtEncMessage.value = data.encrypted_message;
                txtEncKey.value = data.encrypted_aes_key;
                txtIv.value = data.iv;

                // Simulate Transmission
                currentEncryptedData = data;
                transmissionStatus.textContent = "Packet Received! Ready to decrypt.";
                transmissionStatus.className = "text-success fw-bold";
                btnDecrypt.disabled = false;
                
                // Clear previous results
                receiverResult.classList.add('d-none');

            } catch (e) {
                alert("Error encrypting");
            }
        });

        // 3. Decrypt
        btnDecrypt.addEventListener('click', async () => {
            if (!currentEncryptedData) return;
            const privKey = txtPrivateKey.value;

            try {
                const res = await fetch('/api/decrypt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        encrypted_message: currentEncryptedData.encrypted_message,
                        encrypted_aes_key: currentEncryptedData.encrypted_aes_key,
                        iv: currentEncryptedData.iv,
                        private_key: privKey
                    })
                });
                const data = await res.json();

                if (data.success) {
                    receiverResult.classList.remove('d-none');
                    resAesKey.textContent = data.decrypted_aes_key_debug;
                    finalMessage.textContent = data.decrypted_message;
                } else {
                    alert("Decryption failed: " + data.error);
                }

            } catch (e) {
                alert("Error decrypting");
            }
        });
    </script>
    <!-- Info Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">How Secure Messaging Works</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary">1. The Concepts (Vocabulary)</h6>
                            <ul class="list-group list-group-flush mb-3">
                                <li class="list-group-item">
                                    <strong>AES (Symmetric Key)</strong><br>
                                    <small class="text-muted">Think of this as a <em>fast, strong padlock</em>. We use it to lock the actual message because it's very efficient.</small>
                                </li>
                                <li class="list-group-item">
                                    <strong>RSA (Asymmetric Keys)</strong><br>
                                    <small class="text-muted">Think of this as a <em>mailbox</em>.</small>
                                    <ul class="mt-1" style="font-size: 0.85rem;">
                                        <li><strong>Public Key:</strong> The slot. Anyone can drop a message in.</li>
                                        <li><strong>Private Key:</strong> The key to open the mailbox. Only the owner has it.</li>
                                    </ul>
                                </li>
                                <li class="list-group-item">
                                    <strong>IV (Initialization Vector)</strong><br>
                                    <small class="text-muted">A bit of <em>random spice</em> added so that "Hello" encrypted twice doesn't look the same.</small>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6 border-start">
                            <h6 class="fw-bold text-success">2. The Flow (The Story)</h6>
                            <ol class="list-group list-group-numbered list-group-flush">
                                <li class="list-group-item">
                                    <strong>The Setup</strong><br>
                                    Receiver builds a mailbox (RSA Keys) and shares the address (Public Key).
                                </li>
                                <li class="list-group-item">
                                    <strong>The Sending</strong><br>
                                    Sender writes a letter. Creates a new padlock key (AES). Locks the letter (AES Encrypt). Puts the key in the Receiver's mailbox (RSA Encrypt).
                                </li>
                                <li class="list-group-item">
                                    <strong>The Receiving</strong><br>
                                    Receiver opens the mailbox with their secret key (Private Key) to get the padlock key. Then unlocks the letter.
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
